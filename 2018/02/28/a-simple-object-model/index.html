<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
          『译』构建基本对象模型 - 伯爵在古堡
        
    </title>

    <link rel="canonical" href="https://blog.ranchocooper.com/2018/02/28/a-simple-object-model/">

    <!-- Bootstrap Core CSS -->
    
<link rel="stylesheet" href="/css/bootstrap.min.css">


    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/hux-blog.min.css">


    <!-- Pygments Highlight CSS -->
    
<link rel="stylesheet" href="/css/highlight.css">


    <!-- Custom Fonts -->
    <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->


    <script></script>
<meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/rss.xml" title="Rancho" type="application/atom+xml">
</head>

<!-- ga & ba script hoook -->
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-KTG04KL3WB"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-KTG04KL3WB');
</script>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">伯爵在古堡</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>

                    

                        
                    

                        
                    

                        
                        <li>
                            <a href="/archives/">Archives</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/about/">About</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/tags/">Tags</a>
                        </li>
                        
                    

                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Main Content -->
    
<!-- Image to hack wechat -->
<!-- <img src="https://blog.ranchocooper.com/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="{{ site.baseurl }}/{% if page.header-img %}{{ page.header-img }}{% else %}{{ site.header-img }}{% endif %}" width="0" height="0"> -->

<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        background-image: url('/img/home-bg.jpg');
        background-size: cover
    }
</style>
<header class="intro-header" >
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        <span class="tags" style="margin: 5px;">
                            <i class="fa fa-tag"></i>
                        </span>
                        
                          <a class="tag" href="/tags/#编程札记" title="编程札记">编程札记</a>
                        
                    </div>
                    <h1>『译』构建基本对象模型</h1>
                    <h2 class="subheading">A Simple Object Model</h2>
                    <span class="meta">
                        Posted by Rancho on
                        2018-02-28
                    </span>

                    <span class="meta">Word Count 7.9k，
                    32 min to read</span>

                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <link rel="stylesheet" type="text&#x2F;css" href="https://cdnjs.cloudflare.com/ajax/libs/hint.css/2.6.0/hint.min.css"><p><strong><a target="_blank" rel="noopener" href="http://aosabook.org/en/500L/a-simple-object-model.html">原文地址</a></strong></p>
<p>Carl Friedrich Bolz是一位在伦敦国王大学任职的研究员, 他沉迷于动态语言的实现及优化等领域而不可自拔.  他是PyPy&#x2F;RPython的核心开发者之一, 于此同时, 他也在为Prolog, Racket, Smalltalk, PHP和Ruby等语言贡献代码.</p>
<h1 id="开篇"><a href="#开篇" class="headerlink" title="开篇"></a>开篇</h1><p>面向对象编程是目前被广泛使用的一种编程范式, 这种编程范式也被大量现代编程语言所支持. 虽然大部分语言给程序猿提供了相似的面向对象的机制, 但是如果深究细节的话, 还是能发现它们之间还是有很多不同的. 大部分的语言的共同点在于都拥有对象处理和继承机制, 而对于类来说的话, 并不是每种语言都完美支持它. 比如对于Self或者JavaScript这样的基于原型继承的语言来说, 其实是没有类这个概念的, 他们的继承行为都是在对象之间所产生的.</p>
<p>深入了解不同语言的对象模型是一件非常有意思的事儿, 这样我们可以去欣赏不同的编程语言的相似性. 不得不说, 这样的经历可以在我们学习新的语言的时候, 利用上我们已有的经验, 以便于我们快速的掌握它.</p>
<p>这篇文章将会带领你实现一套简单的对象模型. 首先我们将实现一个简单的类与其实例, 并能够通过这个实例去访问一些方法. 这是被诸如Simula 67, malltalk等早期面向对象语言所采用的面向对象模型. 然后我们会一步步的扩展这个模型, 你可以看到接下来两步会为你展现不同语言的模型设计思路. 然后最后一步是来优化我们的对象模型的性能. 最终我们所得到的模型并不是哪一门真实存在的语言所采用的模型. 不过, 硬是要说的话, 你可以把我们得到的最终模型视为一个低配版的Python对象模型.</p>
<p>这篇文章里所展现的对象模型都是基于Python实现的. 代码在Python2.7以及Python3.4上都可以完美运行. 为了让大家更好的了解模型里的设计哲学, 本文也为我们所设计的对象模型准备了单元测试, 这些测试代码可以利用py.test或者nose来运行.</p>
<p>讲真, 用 Python 来作为对象模型的实现语言并不是一个好的选择. 一般而言, 语言的虚拟机都是基于 C&#x2F;C++ 这样更为贴近底层的语言来实现的, 同时在实现中需要非常注意很多的细节, 以保证其执行效率. 不过, Python 这样非常简单的语言能让我们将主要精力都放在不同的行为表现上, 而不是纠结于实现细节不可自拔.</p>
<h1 id="基础方法模型"><a href="#基础方法模型" class="headerlink" title="基础方法模型"></a>基础方法模型</h1><p>我们将以 Smalltalk 中的实现的非常简单的对象模型来开始讲解我们的对象模型. Smalltalk 是一门由施乐帕克研究中心下属的 Alan Kay 所带领的小组在 70 年代所开发出的一门面向对象语言. 它普及了面向对象编程, 同时在今天的编程语言中依然能看到当时它所包含的很多特性. 在 Smalltalk 核心设计原则之一便是：“万物皆对象”. Smalltalk 最广为人知的继承者是 Ruby, 一门使用类似 C 语言语法的同时保留了 Smalltalk 对象模型的语言.</p>
<p>在这一部分中, 我们所实现的对象模型将包含类, 实例, 属性的调用及修改, 方法的调用, 同时允许子类的存在. 开始前, 先声明一下, 这里的类都是有他们自己的属性和方法的普通的类</p>
<p>友情提示：在这篇文章中, “实例”代表着“不是类的对象”的含义.</p>
<p>一个非常好的习惯就是优先编写测试代码, 以此来约束具体实现的行为. 本文所编写的测试代码由两个部分组成. 第一部分由常规的 Python 代码组成, 可能会使用到 Python 中的类及其余一些更高级的特性. 第二部分将会用我们自己建立的对象模型来替代 Python 的类.</p>
<p>在编写测试代码时, 我们需要手动维护常规的 Python 类和我们自建类之间的映射关系. 比如, 在我们自定类中将会使用 <code>obj.read_attr(&quot;attribute&quot;)</code> 来作为 Python 中的 <code>obj.attribute</code> 的替代品. 在现实生活中, 这样的映射关系将由语言的编译器&#x2F;解释器来进行实现.</p>
<p>在本文中, 我们还对模型进行了进一步简化, 这样看起来我们实现对象模型的代码和和编写对象中方法的代码看起来没什么两样. 在现实生活中, 这同样是基本不可能的, 一般而言, 这两者都是由不同的语言实现的.</p>
<p>首先, 让我们来编写一段用于测试读取求改对象字段的代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">test_read_write_field</span>():</span><br><span class="line">    <span class="comment"># Python code</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">A</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">    obj = A()</span><br><span class="line">    obj.a = <span class="number">1</span></span><br><span class="line">    <span class="keyword">assert</span> obj.a == <span class="number">1</span></span><br><span class="line">    obj.b = <span class="number">5</span></span><br><span class="line">    <span class="keyword">assert</span> obj.a == <span class="number">1</span></span><br><span class="line">    <span class="keyword">assert</span> obj.b == <span class="number">5</span></span><br><span class="line">    obj.a = <span class="number">2</span></span><br><span class="line">    <span class="keyword">assert</span> obj.a == <span class="number">2</span></span><br><span class="line">    <span class="keyword">assert</span> obj.b == <span class="number">5</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Object model code</span></span><br><span class="line">    A = Class(name=<span class="string">&quot;A&quot;</span>, base_class=OBJECT, fields=&#123;&#125;, metaclass=TYPE)</span><br><span class="line">    obj = Instance(A)</span><br><span class="line">    obj.write_attr(<span class="string">&quot;a&quot;</span>, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">assert</span> obj.read_attr(<span class="string">&quot;a&quot;</span>) == <span class="number">1</span></span><br><span class="line">    obj.write_attr(<span class="string">&quot;b&quot;</span>, <span class="number">5</span>)</span><br><span class="line">    <span class="keyword">assert</span> obj.read_attr(<span class="string">&quot;a&quot;</span>) == <span class="number">1</span></span><br><span class="line">    <span class="keyword">assert</span> obj.read_attr(<span class="string">&quot;b&quot;</span>) == <span class="number">5</span></span><br><span class="line">    obj.write_attr(<span class="string">&quot;a&quot;</span>, <span class="number">2</span>)</span><br><span class="line">    <span class="keyword">assert</span> obj.read_attr(<span class="string">&quot;a&quot;</span>) == <span class="number">2</span></span><br><span class="line">    <span class="keyword">assert</span> obj.read_attr(<span class="string">&quot;b&quot;</span>) == <span class="number">5</span></span><br></pre></td></tr></table></figure>

<p>在上面这个测试代码中包含了我们必须实现的三个东西. <code>Class</code> 以及 <code>Instance</code> 类分别代表着我们对象中的类以及实例. 同时这里有两个特殊的类的实例：<code>OBJECT</code> 和 <code>TYPE</code>.  <code>OBJECT</code> 对应的是作为 Python 继承系统起点的 <code>object</code> 类（在 Python 2.x 版本中, 实际上是有两套类系统, 一套被统称为 new style class 的新式类, 一套被称为 old style class 的经典类, object 是 new style class 的基类）. <code>TYPE</code> 对应的是 Python 类型系统中的 <code>type</code> .</p>
<p>为了给 <code>Class</code> 以及 <code>Instance</code> 类的实例提供通用操作支持, 这两个类都会从 <code>Base</code> 类这样提供了一系列方法的基础类中进行继承并实现：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Base</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot; The base class that all of the object model classes inherit from. &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, cls, fields</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot; Every object has a class. &quot;&quot;&quot;</span></span><br><span class="line">        self.cls = cls</span><br><span class="line">        self._fields = fields</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">read_attr</span>(<span class="params">self, fieldname</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot; read field &#x27;fieldname&#x27; out of the object &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> self._read_dict(fieldname)</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">write_attr</span>(<span class="params">self, fieldname, value</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot; write field &#x27;fieldname&#x27; into the object &quot;&quot;&quot;</span></span><br><span class="line">        self._write_dict(fieldname, value)</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">isinstance</span>(<span class="params">self, cls</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot; return True if the object is an instance of class cls &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> self.cls.<span class="built_in">issubclass</span>(cls)</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">callmethod</span>(<span class="params">self, methname, *args</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot; call method &#x27;methname&#x27; with arguments &#x27;args&#x27; on object &quot;&quot;&quot;</span></span><br><span class="line">        meth = self.cls._read_from_class(methname)</span><br><span class="line">        <span class="keyword">return</span> meth(self, *args)</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_read_dict</span>(<span class="params">self, fieldname</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot; read an field &#x27;fieldname&#x27; out of the object&#x27;s dict &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> self._fields.get(fieldname, MISSING)</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_write_dict</span>(<span class="params">self, fieldname, value</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot; write a field &#x27;fieldname&#x27; into the object&#x27;s dict &quot;&quot;&quot;</span></span><br><span class="line">        self._fields[fieldname] = value</span><br><span class="line"></span><br><span class="line">MISSING = <span class="built_in">object</span>()</span><br></pre></td></tr></table></figure>

<p><code>Base</code> 实现了对象类的储存, 同时也使用了一个字典来保存对象字段的值. 现在, 我们需要去实现 <code>Class</code> 以及 <code>Instance</code> 类. 在<code>Instance</code> 的构造器中将会完成类的实例化以及 <code>fields</code> 和 <code>dict</code> 初始化的操作. 换句话说, <code>Instance</code> 只是 <code>Base</code> 的子类, 同时并不会为其添加额外的方法.</p>
<p><code>Class</code> 的构造器将会接受类名、基础类、类字典、以及元类这样几个操作. 对于类来讲, 上面几个变量都会在类初始化的时候由用户传递给构造器. 同时构造器也会从它的基类那里获取变量的默认值. 不过这个点, 我们将在下一章节进行讲述.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Instance</span>(<span class="title class_ inherited__">Base</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Instance of a user-defined class. &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, cls</span>):</span><br><span class="line">        <span class="keyword">assert</span> <span class="built_in">isinstance</span>(cls, Class)</span><br><span class="line">        Base.__init__(self, cls, &#123;&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Class</span>(<span class="title class_ inherited__">Base</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot; A User-defined class. &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name, base_class, fields, metaclass</span>):</span><br><span class="line">        Base.__init__(self, metaclass, fields)</span><br><span class="line">        self.name = name</span><br><span class="line">        self.base_class = base_class</span><br></pre></td></tr></table></figure>

<p>同时, 你可能注意到这点, 类依旧是一种特殊的对象, 他们间接的从 Base 中继承. 因此, 类也是一个特殊类的特殊实例, 这样的很特殊的类叫做：元类.</p>
<p>现在, 我们可以顺利通过我们第一组测试. 不过这里, 我们还没有定义 <code>Type</code> 以及 <code>OBJECT</code> 这样两个 <code>Class</code> 的实例. 对于这些东西, 我们将不会按照 Smalltalk 的对象模型进行构建, 因为 Smalltalk 的对象模型对于我们来说太过于复杂. 作为替代品, 我们将采用 ObjVlisp1 的类型系统, Python 的类型系统从这里吸收了不少东西.</p>
<p>在 ObjVlisp 的对象模型中, <code>OBJECT</code> 以及 <code>TYPE</code> 是交杂在一起的. <code>OBJECT</code> 是所有类的母类, 意味着 <code>OBJECT</code> 没有母类. <code>TYPE</code> 是 <code>OBJECT</code> 的子类. 一般而言, 每一个类都是 <code>TYPE</code> 的实例. 在特定情况下, <code>TYPE</code> 和 <code>OBJECT</code> 都是 <code>TYPE</code> 的实例. 不过, 程序猿可以从 <code>TYPE</code> 派生出一个类去作为元类：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># set up the base hierarchy as in Python (the ObjVLisp model)</span></span><br><span class="line"><span class="comment"># the ultimate base class is OBJECT</span></span><br><span class="line">OBJECT = Class(name=<span class="string">&quot;object&quot;</span>, base_class=<span class="literal">None</span>, fields=&#123;&#125;, metaclass=<span class="literal">None</span>)</span><br><span class="line"><span class="comment"># TYPE is a subclass of OBJECT</span></span><br><span class="line">TYPE = Class(name=<span class="string">&quot;type&quot;</span>, base_class=OBJECT, fields=&#123;&#125;, metaclass=<span class="literal">None</span>)</span><br><span class="line"><span class="comment"># TYPE is an instance of itself</span></span><br><span class="line">TYPE.cls = TYPE</span><br><span class="line"><span class="comment"># OBJECT is an instance of TYPE</span></span><br><span class="line">OBJECT.cls = TYPE</span><br></pre></td></tr></table></figure>

<p>为了去编写一个新的元类, 我们需要自行从 <code>TYPE</code> 进行派生. 不过在本文中我们并不会这么做, 我们将只会使用 <code>TYPE</code> 作为我们每个类的元类.</p>
<p>![Figure - Inheritance](Figure - Inheritance.jpg)<br><small class="img-hint">Figure - Inheritance</small></p>
<p>好了, 现在第一组测试已经完全通过了. 现在让我们来看看第二组测试, 我们将会在这组测试中测试对象属性读写是否正常. 这段代码还是很好写的.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">test_read_write_field_class</span>():</span><br><span class="line">    <span class="comment"># classes are objects too</span></span><br><span class="line">    <span class="comment"># Python code</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">A</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    A.a = <span class="number">1</span></span><br><span class="line">    <span class="keyword">assert</span> A.a == <span class="number">1</span></span><br><span class="line">    A.a = <span class="number">6</span></span><br><span class="line">    <span class="keyword">assert</span> A.a == <span class="number">6</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Object model code</span></span><br><span class="line">    A = Class(name=<span class="string">&quot;A&quot;</span>, base_class=OBJECT, fields=&#123;<span class="string">&quot;a&quot;</span>: <span class="number">1</span>&#125;, metaclass=TYPE)</span><br><span class="line">    <span class="keyword">assert</span> A.read_attr(<span class="string">&quot;a&quot;</span>) == <span class="number">1</span></span><br><span class="line">    A.write_attr(<span class="string">&quot;a&quot;</span>, <span class="number">5</span>)</span><br><span class="line">    <span class="keyword">assert</span> A.read_attr(<span class="string">&quot;a&quot;</span>) == <span class="number">5</span></span><br></pre></td></tr></table></figure>

<h2 id="isinstance-检查"><a href="#isinstance-检查" class="headerlink" title="isinstance 检查"></a>isinstance 检查</h2><p>到目前为止, 我们还没有将对象有类这点特性利用起来. 接下来的测试代码将会自动的实现 <code>isinstance</code> .</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">test_isinstance</span>():</span><br><span class="line">    <span class="comment"># Python code</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">A</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">B</span>(<span class="title class_ inherited__">A</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    b = B()</span><br><span class="line">    <span class="keyword">assert</span> <span class="built_in">isinstance</span>(b, B)</span><br><span class="line">    <span class="keyword">assert</span> <span class="built_in">isinstance</span>(b, A)</span><br><span class="line">    <span class="keyword">assert</span> <span class="built_in">isinstance</span>(b, <span class="built_in">object</span>)</span><br><span class="line">    <span class="keyword">assert</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(b, <span class="built_in">type</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Object model code</span></span><br><span class="line">    A = Class(name=<span class="string">&quot;A&quot;</span>, base_class=OBJECT, fields=&#123;&#125;, metaclass=TYPE)</span><br><span class="line">    B = Class(name=<span class="string">&quot;B&quot;</span>, base_class=A, fields=&#123;&#125;, metaclass=TYPE)</span><br><span class="line">    b = Instance(B)</span><br><span class="line">    <span class="keyword">assert</span> b.<span class="built_in">isinstance</span>(B)</span><br><span class="line">    <span class="keyword">assert</span> b.<span class="built_in">isinstance</span>(A)</span><br><span class="line">    <span class="keyword">assert</span> b.<span class="built_in">isinstance</span>(OBJECT)</span><br><span class="line">    <span class="keyword">assert</span> <span class="keyword">not</span> b.<span class="built_in">isinstance</span>(TYPE)</span><br></pre></td></tr></table></figure>

<p>我们可以通过检查 <code>cls</code> 是不是 <code>obj</code> 类或者它自己的超类来判断 <code>obj</code> 对象是不是某些类 <code>cls</code> 的实例. 通过检查一个类是否在一个超类链上工作, 来判断一个类是不是另一个类的超类. 如果还有其余类存在于这个超类链上, 那么这些类也可以被称为是超类. 这个包含了超类和类本身的链条, 被称之为方法解析顺序（简称MRO）. 它很容易以递归的方式进行计算：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Class</span>(<span class="title class_ inherited__">Base</span>):</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">method_resolution_order</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot; compute the method resolution order of the class &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> self.base_class <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> [self]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> [self] + self.base_class.method_resolution_order()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">issubclass</span>(<span class="params">self, cls</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot; is self a subclass of cls? &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> cls <span class="keyword">in</span> self.method_resolution_order()</span><br></pre></td></tr></table></figure>

<p>好了, 在修改代码后, 测试就完全能通过了</p>
<h2 id="方法调用"><a href="#方法调用" class="headerlink" title="方法调用"></a>方法调用</h2><p>前面所建立的对象模型中还缺少了方法调用这样的重要特性. 在本章我们将会建立一个简单的继承模型.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">test_callmethod_simple</span>():</span><br><span class="line">    <span class="comment"># Python code</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">A</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">f</span>(<span class="params">self</span>):</span><br><span class="line">            <span class="keyword">return</span> self.x + <span class="number">1</span></span><br><span class="line">    obj = A()</span><br><span class="line">    obj.x = <span class="number">1</span></span><br><span class="line">    <span class="keyword">assert</span> obj.f() == <span class="number">2</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">B</span>(<span class="title class_ inherited__">A</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    obj = B()</span><br><span class="line">    obj.x = <span class="number">1</span></span><br><span class="line">    <span class="keyword">assert</span> obj.f() == <span class="number">2</span> <span class="comment"># works on subclass too</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Object model code</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">f_A</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self.read_attr(<span class="string">&quot;x&quot;</span>) + <span class="number">1</span></span><br><span class="line">    A = Class(name=<span class="string">&quot;A&quot;</span>, base_class=OBJECT, fields=&#123;<span class="string">&quot;f&quot;</span>: f_A&#125;, metaclass=TYPE)</span><br><span class="line">    obj = Instance(A)</span><br><span class="line">    obj.write_attr(<span class="string">&quot;x&quot;</span>, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">assert</span> obj.callmethod(<span class="string">&quot;f&quot;</span>) == <span class="number">2</span></span><br><span class="line"></span><br><span class="line">    B = Class(name=<span class="string">&quot;B&quot;</span>, base_class=A, fields=&#123;&#125;, metaclass=TYPE)</span><br><span class="line">    obj = Instance(B)</span><br><span class="line">    obj.write_attr(<span class="string">&quot;x&quot;</span>, <span class="number">2</span>)</span><br><span class="line">    <span class="keyword">assert</span> obj.callmethod(<span class="string">&quot;f&quot;</span>) == <span class="number">3</span></span><br></pre></td></tr></table></figure>

<p>为了找到调用对象方法的正确实现, 我们现在开始讨论类对象的方法解析顺序. 在 MRO 中我们所寻找到的类对象字典中第一个方法将会被调用：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Class</span>(<span class="title class_ inherited__">Base</span>):</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_read_from_class</span>(<span class="params">self, methname</span>):</span><br><span class="line">        <span class="keyword">for</span> cls <span class="keyword">in</span> self.method_resolution_order():</span><br><span class="line">            <span class="keyword">if</span> methname <span class="keyword">in</span> cls._fields:</span><br><span class="line">                <span class="keyword">return</span> cls._fields[methname]</span><br><span class="line">        <span class="keyword">return</span> MISSING</span><br></pre></td></tr></table></figure>

<p>在完成 <code>Base</code> 类中 <code>callmethod</code> 实现后, 可以通过上面的测试.</p>
<p>为了保证函数参数传递正确, 同时也确保我们事先的代码能完成方法重载的功能, 我们可以编写下面这段测试代码, 当然结果是完美通过测试：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">test_callmethod_subclassing_and_arguments</span>():</span><br><span class="line">    <span class="comment"># Python code</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">A</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">g</span>(<span class="params">self, arg</span>):</span><br><span class="line">            <span class="keyword">return</span> self.x + arg</span><br><span class="line">    obj = A()</span><br><span class="line">    obj.x = <span class="number">1</span></span><br><span class="line">    <span class="keyword">assert</span> obj.g(<span class="number">4</span>) == <span class="number">5</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">B</span>(<span class="title class_ inherited__">A</span>):</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">g</span>(<span class="params">self, arg</span>):</span><br><span class="line">            <span class="keyword">return</span> self.x + arg * <span class="number">2</span></span><br><span class="line">    obj = B()</span><br><span class="line">    obj.x = <span class="number">4</span></span><br><span class="line">    <span class="keyword">assert</span> obj.g(<span class="number">4</span>) == <span class="number">12</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Object model code</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">g_A</span>(<span class="params">self, arg</span>):</span><br><span class="line">        <span class="keyword">return</span> self.read_attr(<span class="string">&quot;x&quot;</span>) + arg</span><br><span class="line">    A = Class(name=<span class="string">&quot;A&quot;</span>, base_class=OBJECT, fields=&#123;<span class="string">&quot;g&quot;</span>: g_A&#125;, metaclass=TYPE)</span><br><span class="line">    obj = Instance(A)</span><br><span class="line">    obj.write_attr(<span class="string">&quot;x&quot;</span>, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">assert</span> obj.callmethod(<span class="string">&quot;g&quot;</span>, <span class="number">4</span>) == <span class="number">5</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">g_B</span>(<span class="params">self, arg</span>):</span><br><span class="line">        <span class="keyword">return</span> self.read_attr(<span class="string">&quot;x&quot;</span>) + arg * <span class="number">2</span></span><br><span class="line">    B = Class(name=<span class="string">&quot;B&quot;</span>, base_class=A, fields=&#123;<span class="string">&quot;g&quot;</span>: g_B&#125;, metaclass=TYPE)</span><br><span class="line">    obj = Instance(B)</span><br><span class="line">    obj.write_attr(<span class="string">&quot;x&quot;</span>, <span class="number">4</span>)</span><br><span class="line">    <span class="keyword">assert</span> obj.callmethod(<span class="string">&quot;g&quot;</span>, <span class="number">4</span>) == <span class="number">12</span></span><br></pre></td></tr></table></figure>

<h1 id="基础属性模型"><a href="#基础属性模型" class="headerlink" title="基础属性模型"></a>基础属性模型</h1><p>现在最简单版本的对象模型已经可以开始工作了, 不过我们还需要去不断的改进. 这一部分将会介绍基础方法模型和基础属性模型之间的差异. 这也是 Smalltalk 、 Ruby 、 JavaScript 、 Python 和 Lua 之间的核心差异.</p>
<p>基础方法模型将会按照最原始的方式去调用方法：</p>
<pre><code>result = obj.f(arg1, arg2)
</code></pre>
<p>基础属性模型将会将调用过程分为两步：寻找属性, 以及返回执行结果：</p>
<pre><code>method = obj.f
result = method(arg1, arg2)
</code></pre>
<p>你可以在接下来的测试中体会到前文所述的差异：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">test_bound_method</span>():</span><br><span class="line">    <span class="comment"># Python code</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">A</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">f</span>(<span class="params">self, a</span>):</span><br><span class="line">            <span class="keyword">return</span> self.x + a + <span class="number">1</span></span><br><span class="line">    obj = A()</span><br><span class="line">    obj.x = <span class="number">2</span></span><br><span class="line">    m = obj.f</span><br><span class="line">    <span class="keyword">assert</span> m(<span class="number">4</span>) == <span class="number">7</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">B</span>(<span class="title class_ inherited__">A</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    obj = B()</span><br><span class="line">    obj.x = <span class="number">1</span></span><br><span class="line">    m = obj.f</span><br><span class="line">    <span class="keyword">assert</span> m(<span class="number">10</span>) == <span class="number">12</span> <span class="comment"># works on subclass too</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Object model code</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">f_A</span>(<span class="params">self, a</span>):</span><br><span class="line">        <span class="keyword">return</span> self.read_attr(<span class="string">&quot;x&quot;</span>) + a + <span class="number">1</span></span><br><span class="line">    A = Class(name=<span class="string">&quot;A&quot;</span>, base_class=OBJECT, fields=&#123;<span class="string">&quot;f&quot;</span>: f_A&#125;, metaclass=TYPE)</span><br><span class="line">    obj = Instance(A)</span><br><span class="line">    obj.write_attr(<span class="string">&quot;x&quot;</span>, <span class="number">2</span>)</span><br><span class="line">    m = obj.read_attr(<span class="string">&quot;f&quot;</span>)</span><br><span class="line">    <span class="keyword">assert</span> m(<span class="number">4</span>) == <span class="number">7</span></span><br><span class="line"></span><br><span class="line">    B = Class(name=<span class="string">&quot;B&quot;</span>, base_class=A, fields=&#123;&#125;, metaclass=TYPE)</span><br><span class="line">    obj = Instance(B)</span><br><span class="line">    obj.write_attr(<span class="string">&quot;x&quot;</span>, <span class="number">1</span>)</span><br><span class="line">    m = obj.read_attr(<span class="string">&quot;f&quot;</span>)</span><br><span class="line">    <span class="keyword">assert</span> m(<span class="number">10</span>) == <span class="number">12</span></span><br></pre></td></tr></table></figure>

<p>我们可以按照之前测试代码中对方法调用设置一样的步骤去设置属性调用, 不过和方法调用相比, 这里面发生了一些变化. 首先, 我们将会在对象中寻找与函数名对应的方法名. 这样一个查找过程结果被称之为已绑定的方法, 具体来说就是, 这个结果一个绑定了方法与具体对象的特殊对象. 然后这个绑定方法会在接下来的操作中被调用.</p>
<p>为了实现这样的操作, 我们需要修改 <code>Base.read_attr</code> 的实现. 如果在实例字典中没有找到对应的属性, 那么我们需要去在类字典中查找. 如果在类字典中查找到了这个属性, 那么我们将会执行方法绑定的操作. 我们可以使用一个闭包来很简单的模拟绑定方法. 除了更改 <code>Base.read_attr</code> 实现以外, 我们也可以修改 <code>Base.callmethod</code> 方法来确保我们代码能通过测试.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Base</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">read_attr</span>(<span class="params">self, fieldname</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot; read field &#x27;fieldname&#x27; out of the object &quot;&quot;&quot;</span></span><br><span class="line">        result = self._read_dict(fieldname)</span><br><span class="line">        <span class="keyword">if</span> result <span class="keyword">is</span> <span class="keyword">not</span> MISSING:</span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">        result = self.cls._read_from_class(fieldname)</span><br><span class="line">        <span class="keyword">if</span> _is_bindable(result):</span><br><span class="line">            <span class="keyword">return</span> _make_boundmethod(result, self)</span><br><span class="line">        <span class="keyword">if</span> result <span class="keyword">is</span> <span class="keyword">not</span> MISSING:</span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">        <span class="keyword">raise</span> AttributeError(fieldname)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">callmethod</span>(<span class="params">self, methname, *args</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot; call method &#x27;methname&#x27; with arguments &#x27;args&#x27; on object &quot;&quot;&quot;</span></span><br><span class="line">        meth = self.read_attr(methname)</span><br><span class="line">        <span class="keyword">return</span> meth(*args)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_is_bindable</span>(<span class="params">meth</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">callable</span>(meth)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_make_boundmethod</span>(<span class="params">meth, self</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">bound</span>(<span class="params">*args</span>):</span><br><span class="line">        <span class="keyword">return</span> meth(self, *args)</span><br><span class="line">    <span class="keyword">return</span> bound</span><br></pre></td></tr></table></figure>

<p>其余的代码并不需要修改.</p>
<h2 id="元对象协议"><a href="#元对象协议" class="headerlink" title="元对象协议"></a>元对象协议</h2><p>除了常规的类方法之外, 很多动态语言还支持特殊方法. 有这样一些方法在调用时是由对象系统调用而不是使用常规调用. 在 Python 中你可以看到这些方法的方法名用两个下划线作为开头和结束的, 比如 <code>__init__</code> . 特殊方法可以用于重载一些常规操作, 同时可以提供一些自定义的功能. 因此, 它们的存在可以告诉对象模型如何自动的处理不同的事情. Python 中相关特殊方法的说明可以查看<a target="_blank" rel="noopener" href="https://docs.python.org/3/reference/datamodel.html#special-method-names">这篇文档</a>.</p>
<p>元对象协议这一概念由 Smalltalk 引入, 然后在诸如 CLOS 这样的通用 Lisp 的对象模型中也广泛的使用这个概念. 这个概念包含特殊方法的集合（注：这里没有查到 coined3 的梗, 请校者帮忙参考）.</p>
<p>在这一章中, 我们将会为我们的对象模型添加三个元调用操作. 它们将会用来对我们读取和修改对象的操作进行更为精细的控制. 我们首先要添加的两个方法是 <code>__getattr__</code> 和 <code>__setattr__</code>,  这两个方法的命名看起来和我们 Python 中相同功能函数的方法名很相似.</p>
<h2 id="自定义属性读写操作"><a href="#自定义属性读写操作" class="headerlink" title="自定义属性读写操作"></a>自定义属性读写操作</h2><p><code>__getattr__</code> 方法将会在属性通过常规方法无法查找到的情况下被调用, 换句话说, 在实例字典、类字典、父类字典等等对象中都找不到对应的属性时, 会触发该方法的调用. 我们将传入一个被查找属性的名字作为这个方法的参数. 在早期的 Smalltalk4 中这个方法被称为 <code>doesNotUnderstand</code> .</p>
<p>在 <code>__setattr__</code> 这里事情可能发生了点变化. 首先我们需要明确一点的是, 设置一个属性的时候通常意味着我们需要创建它, 在这个时候, 在设置属性的时候通常会触发 <code>__setattr__</code> 方法. 为了确保 <code>__setattr__</code> 的存在, 我们需要在 <code>OBJECT</code> 对象中实现 <code>__setattr__</code> 方法. 这样最基础的实现完成了我们向相对应的字典里写入属性的操作. 这可以使得用户可以将自己定义的 <code>__setattr__</code> 委托给 <code>OBJECT.__setattr__</code> 方法.</p>
<p>针对这两个特殊方法的测试用例如下所示：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">test_getattr</span>():</span><br><span class="line">    <span class="comment"># Python code</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">A</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">__getattr__</span>(<span class="params">self, name</span>):</span><br><span class="line">            <span class="keyword">if</span> name == <span class="string">&quot;fahrenheit&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> self.celsius * <span class="number">9</span>\. / <span class="number">5</span>\. + <span class="number">32</span></span><br><span class="line">            <span class="keyword">raise</span> AttributeError(name)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">__setattr__</span>(<span class="params">self, name, value</span>):</span><br><span class="line">            <span class="keyword">if</span> name == <span class="string">&quot;fahrenheit&quot;</span>:</span><br><span class="line">                self.celsius = (value - <span class="number">32</span>) * <span class="number">5</span>\. / <span class="number">9.</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># call the base implementation</span></span><br><span class="line">                <span class="built_in">object</span>.__setattr__(self, name, value)</span><br><span class="line">    obj = A()</span><br><span class="line">    obj.celsius = <span class="number">30</span></span><br><span class="line">    <span class="keyword">assert</span> obj.fahrenheit == <span class="number">86</span> <span class="comment"># test __getattr__</span></span><br><span class="line">    obj.celsius = <span class="number">40</span></span><br><span class="line">    <span class="keyword">assert</span> obj.fahrenheit == <span class="number">104</span></span><br><span class="line"></span><br><span class="line">    obj.fahrenheit = <span class="number">86</span> <span class="comment"># test __setattr__</span></span><br><span class="line">    <span class="keyword">assert</span> obj.celsius == <span class="number">30</span></span><br><span class="line">    <span class="keyword">assert</span> obj.fahrenheit == <span class="number">86</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Object model code</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getattr__</span>(<span class="params">self, name</span>):</span><br><span class="line">        <span class="keyword">if</span> name == <span class="string">&quot;fahrenheit&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> self.read_attr(<span class="string">&quot;celsius&quot;</span>) * <span class="number">9</span>\. / <span class="number">5</span>\. + <span class="number">32</span></span><br><span class="line">        <span class="keyword">raise</span> AttributeError(name)</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__setattr__</span>(<span class="params">self, name, value</span>):</span><br><span class="line">        <span class="keyword">if</span> name == <span class="string">&quot;fahrenheit&quot;</span>:</span><br><span class="line">            self.write_attr(<span class="string">&quot;celsius&quot;</span>, (value - <span class="number">32</span>) * <span class="number">5</span>\. / <span class="number">9.</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># call the base implementation</span></span><br><span class="line">            OBJECT.read_attr(<span class="string">&quot;__setattr__&quot;</span>)(self, name, value)</span><br><span class="line"></span><br><span class="line">    A = Class(name=<span class="string">&quot;A&quot;</span>, base_class=OBJECT,</span><br><span class="line">              fields=&#123;<span class="string">&quot;__getattr__&quot;</span>: __getattr__, <span class="string">&quot;__setattr__&quot;</span>: __setattr__&#125;,</span><br><span class="line">              metaclass=TYPE)</span><br><span class="line">    obj = Instance(A)</span><br><span class="line">    obj.write_attr(<span class="string">&quot;celsius&quot;</span>, <span class="number">30</span>)</span><br><span class="line">    <span class="keyword">assert</span> obj.read_attr(<span class="string">&quot;fahrenheit&quot;</span>) == <span class="number">86</span> <span class="comment"># test __getattr__</span></span><br><span class="line">    obj.write_attr(<span class="string">&quot;celsius&quot;</span>, <span class="number">40</span>)</span><br><span class="line">    <span class="keyword">assert</span> obj.read_attr(<span class="string">&quot;fahrenheit&quot;</span>) == <span class="number">104</span></span><br><span class="line">    obj.write_attr(<span class="string">&quot;fahrenheit&quot;</span>, <span class="number">86</span>) <span class="comment"># test __setattr__</span></span><br><span class="line">    <span class="keyword">assert</span> obj.read_attr(<span class="string">&quot;celsius&quot;</span>) == <span class="number">30</span></span><br><span class="line">    <span class="keyword">assert</span> obj.read_attr(<span class="string">&quot;fahrenheit&quot;</span>) == <span class="number">86</span></span><br></pre></td></tr></table></figure>

<p>为了通过测试, 我们需要修改下 <code>Base.read_attr</code> 以及 <code>Base.write_attr</code> 两个方法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Base</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">read_attr</span>(<span class="params">self, fieldname</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot; read field &#x27;fieldname&#x27; out of the object &quot;&quot;&quot;</span></span><br><span class="line">        result = self._read_dict(fieldname)</span><br><span class="line">        <span class="keyword">if</span> result <span class="keyword">is</span> <span class="keyword">not</span> MISSING:</span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">        result = self.cls._read_from_class(fieldname)</span><br><span class="line">        <span class="keyword">if</span> _is_bindable(result):</span><br><span class="line">            <span class="keyword">return</span> _make_boundmethod(result, self)</span><br><span class="line">        <span class="keyword">if</span> result <span class="keyword">is</span> <span class="keyword">not</span> MISSING:</span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">        meth = self.cls._read_from_class(<span class="string">&quot;__getattr__&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> meth <span class="keyword">is</span> <span class="keyword">not</span> MISSING:</span><br><span class="line">            <span class="keyword">return</span> meth(self, fieldname)</span><br><span class="line">        <span class="keyword">raise</span> AttributeError(fieldname)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">write_attr</span>(<span class="params">self, fieldname, value</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot; write field &#x27;fieldname&#x27; into the object &quot;&quot;&quot;</span></span><br><span class="line">        meth = self.cls._read_from_class(<span class="string">&quot;__setattr__&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> meth(self, fieldname, value)</span><br></pre></td></tr></table></figure>

<p>获取属性的过程变成调用 <code>__getattr__</code> 方法并传入字段名作为参数, 如果字段不存在, 将会抛出一个异常. 请注意 <code>__getattr__</code> 只能在类中调用（Python 中的特殊方法也是这样）, 同时需要避免这样的 <code>self.read_attr(&quot;__getattr__&quot;)</code> 递归调用, 因为如果 <code>__getattr__</code> 方法没有定义的话, 上面的调用会造成无限递归.</p>
<p>对属性的修改操作也会像读取一样交给 <code>__setattr__</code> 方法执行. 为了保证这个方法能够正常执行, <code>OBJECT</code> 需要实现 <code>__setattr__</code> 的默认行为, 比如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">OBJECT__setattr__</span>(<span class="params">self, fieldname, value</span>):</span><br><span class="line">    self._write_dict(fieldname, value)</span><br><span class="line">OBJECT = Class(<span class="string">&quot;object&quot;</span>, <span class="literal">None</span>, &#123;<span class="string">&quot;__setattr__&quot;</span>: OBJECT__setattr__&#125;, <span class="literal">None</span>)</span><br></pre></td></tr></table></figure>

<p><code>OBJECT.__setattr__</code> 的具体实现和之前 <code>write_attr</code> 方法的实现有着相似之处. 在完成这些修改后, 我们可以顺利的通过我们的测试.</p>
<h2 id="描述符协议"><a href="#描述符协议" class="headerlink" title="描述符协议"></a>描述符协议</h2><p>在上面的测试中, 我们频繁的在不同的温标之间切换, 不得不说, 在执行修改属性操作的时候这样真的很蛋疼, 所以我们需要在 <code>__getattr__</code> 和 <code>__setattr__</code> 中检查所使用的的属性的名称为了解决这个问题, 在 Python 中引入了<strong>描述符协议</strong>的概念.</p>
<p>我们将从 <code>__getattr__</code> 和 <code>__setattr__</code> 方法中获取具体的属性, 而描述符协议则是在属性调用过程结束返回结果时触发一个特殊的方法. 描述符协议可以视为一种可以绑定类与方法的特殊手段, 我们可以使用描述符协议来完成将方法绑定到对象的具体操作. 除了绑定方法, 在 Python 中描述符最重要的几个使用场景之一就是 <code>staticmethod</code>、 <code>classmethod</code> 和 <code>property</code>.</p>
<p>在接下来一点文字中, 我们将介绍怎么样来使用描述符进行对象绑定. 我们可以通过使用 <code>__get__</code> 方法来达成这一目标, 具体请看下面的测试代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">test_get</span>():</span><br><span class="line">    <span class="comment"># Python code</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">FahrenheitGetter</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">__get__</span>(<span class="params">self, inst, cls</span>):</span><br><span class="line">            <span class="keyword">return</span> inst.celsius * <span class="number">9</span>\. / <span class="number">5</span>\. + <span class="number">32</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">A</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">        fahrenheit = FahrenheitGetter()</span><br><span class="line">    obj = A()</span><br><span class="line">    obj.celsius = <span class="number">30</span></span><br><span class="line">    <span class="keyword">assert</span> obj.fahrenheit == <span class="number">86</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Object model code</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">FahrenheitGetter</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">__get__</span>(<span class="params">self, inst, cls</span>):</span><br><span class="line">            <span class="keyword">return</span> inst.read_attr(<span class="string">&quot;celsius&quot;</span>) * <span class="number">9</span>\. / <span class="number">5</span>\. + <span class="number">32</span></span><br><span class="line"></span><br><span class="line">    A = Class(name=<span class="string">&quot;A&quot;</span>, base_class=OBJECT,</span><br><span class="line">              fields=&#123;<span class="string">&quot;fahrenheit&quot;</span>: FahrenheitGetter()&#125;,</span><br><span class="line">              metaclass=TYPE)</span><br><span class="line">    obj = Instance(A)</span><br><span class="line">    obj.write_attr(<span class="string">&quot;celsius&quot;</span>, <span class="number">30</span>)</span><br><span class="line">    <span class="keyword">assert</span> obj.read_attr(<span class="string">&quot;fahrenheit&quot;</span>) == <span class="number">86</span></span><br></pre></td></tr></table></figure>

<p><code>__get__</code> 方法将会在属性查找完后被 <code>FahrenheitGetter</code> 实例所调用. 传递给 <code>__get__</code> 的参数是查找过程结束时所处的那个实例.</p>
<p>实现这样的功能倒是很简单, 我们可以很简单的修改 <code>_is_bindable</code> 和 <code>_make_boundmethod</code> 方法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">_is_bindable</span>(<span class="params">meth</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">hasattr</span>(meth, <span class="string">&quot;__get__&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_make_boundmethod</span>(<span class="params">meth, self</span>):</span><br><span class="line">    <span class="keyword">return</span> meth.__get__(self, <span class="literal">None</span>)</span><br></pre></td></tr></table></figure>

<p>好了, 这样简单的修改能保证我们通过测试了. 之前关于方法绑定的测试也能通过了, 在 Python 中 <code>__get__</code> 方法执行完了将会返回一个已绑定方法对象.</p>
<p>在实践中, 描述符协议的确看起来比较复杂. 它同时还包含用于设置属性的 <code>__set__</code> 方法. 此外, 你现在所看到我们实现的版本是经过一些简化的. 请注意, 前面 <code>_make_boundmethod</code> 方法调用 <code>__get__</code> 是实现级的操作, 而不是使用 <code>meth.read_attr(&#39;__get__&#39;)</code> . 这是很有必要的, 因为我们的对象模型只是从 Python 中借用函数和方法, 而不是展示 Python 的对象模型. 进一步完善模型的话可以有效解决这个问题.</p>
<h1 id="实例优化"><a href="#实例优化" class="headerlink" title="实例优化"></a>实例优化</h1><p>这个对象模型前面三个部分的建立过程中伴随着很多的行为变化, 而最后一部分的优化工作并不会伴随着行为变化. 这种优化方式被称为 map ,广泛存在在可以自举的语言虚拟机中. 这是一种最ä¸º重要对象模型优化手段：在 PyPy , 诸如 V8 现代 JavaScript 虚拟机中得到应用（在 V8 中这种方法被称为 hidden classes）.</p>
<p>这种优化手段基于如下的观察：到目前所实现的对象模型中, 所有实例都使用一个完整的字典来储存他们的属性. 字典是基于哈希表进行实现的, 这将会耗费大量的内存. 在很多时候, 同一个类的实例将会拥有同样的属性, 比如, 有一个类 <code>Point</code> , 它所有的实例都包含同样的属性 <code>x</code> <code>y</code>.</p>
<p><code>Map</code> 优化利用了这样一个事实. 它将会将每个实例的字典分割为两个部分. 一部分存放可以在所有实例中共享的属性名. 然后另一部分只存放对第一部分产生的 <code>Map</code> 的引用和存放具体的值. 存放属性名的 <strong>map</strong> 将会作为值的索引.</p>
<p>我们将为上面所述的需求编写一些测试用例, 如下所示：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">test_maps</span>():</span><br><span class="line">    <span class="comment"># white box test inspecting the implementation</span></span><br><span class="line">    Point = Class(name=<span class="string">&quot;Point&quot;</span>, base_class=OBJECT, fields=&#123;&#125;, metaclass=TYPE)</span><br><span class="line">    p1 = Instance(Point)</span><br><span class="line">    p1.write_attr(<span class="string">&quot;x&quot;</span>, <span class="number">1</span>)</span><br><span class="line">    p1.write_attr(<span class="string">&quot;y&quot;</span>, <span class="number">2</span>)</span><br><span class="line">    <span class="keyword">assert</span> p1.storage == [<span class="number">1</span>, <span class="number">2</span>]</span><br><span class="line">    <span class="keyword">assert</span> p1.<span class="built_in">map</span>.attrs == &#123;<span class="string">&quot;x&quot;</span>: <span class="number">0</span>, <span class="string">&quot;y&quot;</span>: <span class="number">1</span>&#125;</span><br><span class="line"></span><br><span class="line">    p2 = Instance(Point)</span><br><span class="line">    p2.write_attr(<span class="string">&quot;x&quot;</span>, <span class="number">5</span>)</span><br><span class="line">    p2.write_attr(<span class="string">&quot;y&quot;</span>, <span class="number">6</span>)</span><br><span class="line">    <span class="keyword">assert</span> p1.<span class="built_in">map</span> <span class="keyword">is</span> p2.<span class="built_in">map</span></span><br><span class="line">    <span class="keyword">assert</span> p2.storage == [<span class="number">5</span>, <span class="number">6</span>]</span><br><span class="line"></span><br><span class="line">    p1.write_attr(<span class="string">&quot;x&quot;</span>, -<span class="number">1</span>)</span><br><span class="line">    p1.write_attr(<span class="string">&quot;y&quot;</span>, -<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">assert</span> p1.<span class="built_in">map</span> <span class="keyword">is</span> p2.<span class="built_in">map</span></span><br><span class="line">    <span class="keyword">assert</span> p1.storage == [-<span class="number">1</span>, -<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">    p3 = Instance(Point)</span><br><span class="line">    p3.write_attr(<span class="string">&quot;x&quot;</span>, <span class="number">100</span>)</span><br><span class="line">    p3.write_attr(<span class="string">&quot;z&quot;</span>, -<span class="number">343</span>)</span><br><span class="line">    <span class="keyword">assert</span> p3.<span class="built_in">map</span> <span class="keyword">is</span> <span class="keyword">not</span> p1.<span class="built_in">map</span></span><br><span class="line">    <span class="keyword">assert</span> p3.<span class="built_in">map</span>.attrs == &#123;<span class="string">&quot;x&quot;</span>: <span class="number">0</span>, <span class="string">&quot;z&quot;</span>: <span class="number">1</span>&#125;</span><br></pre></td></tr></table></figure>

<p>注意, 这里测试代码的风格和我们之前的才是代码看起不太一样. 之前所有的测试只是通过已实现的接口来测试类的功能. 这里的测试通过读取类的内部属性来获取实现的详细信息, 并将其与预设的值进行比较. 这种测试方法又被称之为白盒测试.</p>
<p><code>p1</code> 的包含 <code>attrs</code> 的 <code>map</code> 存放了 <code>x</code> 和 <code>y</code> 两个属性, 其在 <code>p1</code> 中存放的值分别为 0 和 1. 然后创建第二个实例 <code>p2</code> , 并通过同样的方法网同样的 <code>map</code> 中添加同样的属性.  换句话说, 如果不同的属性被添加了, 那么其中的 <code>map</code> 是不通用的.</p>
<p><code>Map</code> 类长下面这样：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Map</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, attrs</span>):</span><br><span class="line">        self.attrs = attrs</span><br><span class="line">        self.next_maps = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_index</span>(<span class="params">self, fieldname</span>):</span><br><span class="line">        <span class="keyword">return</span> self.attrs.get(fieldname, -<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">next_map</span>(<span class="params">self, fieldname</span>):</span><br><span class="line">        <span class="keyword">assert</span> fieldname <span class="keyword">not</span> <span class="keyword">in</span> self.attrs</span><br><span class="line">        <span class="keyword">if</span> fieldname <span class="keyword">in</span> self.next_maps:</span><br><span class="line">            <span class="keyword">return</span> self.next_maps[fieldname]</span><br><span class="line">        attrs = self.attrs.copy()</span><br><span class="line">        attrs[fieldname] = <span class="built_in">len</span>(attrs)</span><br><span class="line">        result = self.next_maps[fieldname] = Map(attrs)</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">EMPTY_MAP = Map(&#123;&#125;)</span><br></pre></td></tr></table></figure>

<p><code>Map</code> 类拥有两个方法, 分别是 <code>get_index</code> 和 <code>next_map</code> . 前者用于查找对象储存空间中的索引中查找对应的属性名称. 而在新的属性添加到对象中时应该使用后者. 在这种情况下, 不同的实例需要用 <code>next_map</code> 计算不同的映射关系. 这个方法将会使用 <code>next_maps</code> 来查找已经存在的映射. 这样, 相似的实例将会使用相似的 <code>Map</code> 对象.</p>
<p>![Figure - Map transitions](Figure - Map transitions.jpg)<br><small class="img-hint">Figure - Map transitions</small></p>
<p>使用 <code>map</code> 的 <code>Instance</code> 实现如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Instance</span>(<span class="title class_ inherited__">Base</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Instance of a user-defined class. &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, cls</span>):</span><br><span class="line">        <span class="keyword">assert</span> <span class="built_in">isinstance</span>(cls, Class)</span><br><span class="line">        Base.__init__(self, cls, <span class="literal">None</span>)</span><br><span class="line">        self.<span class="built_in">map</span> = EMPTY_MAP</span><br><span class="line">        self.storage = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_read_dict</span>(<span class="params">self, fieldname</span>):</span><br><span class="line">        index = self.<span class="built_in">map</span>.get_index(fieldname)</span><br><span class="line">        <span class="keyword">if</span> index == -<span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> MISSING</span><br><span class="line">        <span class="keyword">return</span> self.storage[index]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_write_dict</span>(<span class="params">self, fieldname, value</span>):</span><br><span class="line">        index = self.<span class="built_in">map</span>.get_index(fieldname)</span><br><span class="line">        <span class="keyword">if</span> index != -<span class="number">1</span>:</span><br><span class="line">            self.storage[index] = value</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            new_map = self.<span class="built_in">map</span>.next_map(fieldname)</span><br><span class="line">            self.storage.append(value)</span><br><span class="line">            self.<span class="built_in">map</span> = new_map</span><br></pre></td></tr></table></figure>

<p>现在这个类将给 <code>Base</code> 类传递 <code>None</code> 作为字段字典, 那是因为 <code>Instance</code> 将会以另一种方式构建存储字典. 因此它需要重载 <code>_read_dict</code> 和 <code>_write_dict</code> . 在实际操作中, 我们将重构 <code>Base</code> 类, 使其不在负责存放字段字典. 不过眼下, 我们传递一个 <code>None</code> 作为参数就足够了.</p>
<p>在一个新的实例创建之初使用的是 <code>EMPTY_MAP</code> , 这里面没有任何的对象存放着. 在实现 <code>_read_dict</code> 后, 我们将从实例的 <code>map</code> 中查找属性名的索引, 然后映射相对应的储存表.</p>
<p>向字段字典写入数据分为两种情况. 第一种是现有属性值的修改, 那么就简单的在映射的列表中修改对应的值就好. 而如果对应属性不存在, 那么需要进行 <code>map</code> 变换（如上面的图所示一样）, 将会调用 <code>next_map</code> 方法, 然后将新的值存放入储存列表中.</p>
<p>你肯定想问, 这种优化方式到底优化了什么？一般而言, 在具有很多相似结构实例的情况下能较好的优化内存. 但是请记住, 这不是一个通用的优化手段. 有些时候代码中充斥着结构不同的实例之时, 这种手段可能会耗费更大的空间.</p>
<p>这是动态语言优化中的常见问题. 一般而言, 不太可能找到一种万能的方法去优化代码, 使其更快, 更节省空间. 因此, 具体情况具体分析, 我们需要根据不同的情况去选择优化方式.</p>
<p>在 <code>Map</code> 优化中很有意思的一点就是, 虽然这里只有花了内存占用, 但是在 VM 使用 JIT 技术的情况下, 也能较好的提高程序的性能. 为了实现这一点, JIT 技术使用映射来查找属性在存储空间中的偏移量. 然后完全除去字典查找的方式.</p>
<h1 id="潜在扩展"><a href="#潜在扩展" class="headerlink" title="潜在扩展"></a>潜在扩展</h1><p>扩展我们的对象模型和引入不同语言的设计选择是一件非常容易的事儿. 这里给出一些可能的方向：</p>
<ul>
<li><p>最简单的是添加更多的特殊方法方法, 比如一些 <code>__init__</code>, <code>__getattribute__</code>, <code>__set__</code> 这样非常容易实现和有趣的方法.</p>
</li>
<li><p>扩展模型支持多重继承. 为了实现这一点, 每一个类都需要一个父类列表. 然后 <code>Class.method_resolution_order</code> 需要进行修改, 以便支持方法查找. 一个简单的 MRO 计算规则可以使用深度优先原则. 然后更为复杂的可以采用<a target="_blank" rel="noopener" href="https://www.python.org/download/releases/2.3/mro/">C3 算法</a>, 这种算法能更好的处理菱形继承结构所带来的一些问题.</p>
</li>
<li><p>一个更为疯狂的想法是切换到原型模式, 这需要消除类和实例之间的差别.</p>
</li>
</ul>
<p>总结<br>面向对象编程语言设计的核心是其对象模型的细节. 编写一些简单的对象模型是一件非常简单而且有趣的事情. 你可以通过这种方式来了解现有语言的工作机制, 并且深入了解面向对象语言的设计原则. 编写不同的对象模型验证不同对象的设计思路是一个非常棒的方法. 你也不在需要将注意力放在其余一些琐碎的事情上, 比如解析和执行代码.</p>
<p>这样编写对象模型的工作在实践中也是非常有用的. 除了作为实验品以外, 它们还可以被其余语言所使用. 这种例子有很多：比如 GObject 模型, 用 C 语言编写, 在 GLib 和 其余 Gonme 中得到使用, 还有就是用 JavaScript 实现的各类对象模型.</p>


                <hr>

                

                <ul class="pager">
                    
                        <li class="previous">
                            <a href="/2018/06/13/singleton-in-python/" data-toggle="tooltip" data-placement="top" title="Python 单例模式">&larr; Previous Post</a>
                        </li>
                    
                    
                        <li class="next">
                            <a href="/2017/10/03/python-stdlib-04dates-and-times/" data-toggle="tooltip" data-placement="top" title="时间和日期">Next Post &rarr;</a>
                        </li>
                    
                </ul>

                

                
                <!-- disqus 评论框 start -->
                <div class="comment">
                    <div id="disqus_thread" class="disqus-thread"></div>
                </div>
                <!-- disqus 评论框 end -->
                

            </div>
    <!-- Side Catalog Container -->
        
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
        

    <!-- Sidebar Container -->

            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                       
                          <a class="tag" href="/tags/#编程札记" title="编程札记">编程札记</a>
                        
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
                <hr>
                <h5>FRIENDS</h5>
                <ul class="list-inline">

                    
                        <li><a href="http://0v0.link/" target="_blank">七秒不觉梦</a></li>
                    
                        <li><a href="https://xlzd.me/" target="_blank">海盗杂谈</a></li>
                    
                        <li><a href="https://www.yhspy.com/" target="_blank">Web云端研究所</a></li>
                    
                        <li><a href="http://mindhacks.cn/" target="_blank">Mind Hack</a></li>
                    
                        <li><a href="" target="_blank"></a></li>
                    
                        <li><a href="" target="_blank"></a></li>
                    
                </ul>
                
            </div>

        </div>
    </div>
</article>




<!-- disqus 公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = "ranchocooper";
    var disqus_identifier = "https://blog.ranchocooper.com/2018/02/28/a-simple-object-model/";
    var disqus_url = "https://blog.ranchocooper.com/2018/02/28/a-simple-object-model/";

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<!-- disqus 公共JS代码 end -->




<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'always',
          placement: 'right',
          icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    
                            
                                    
                                        <li>
                                            <a target="_blank"
                                                href="https://www.zhihu.com/people/ranchocooper">
                                                <span class="fa-stack fa-lg">
                                                    <i class="fa fa-circle fa-stack-2x"></i>
                                                    <i class="fa  fa-stack-1x fa-inverse">知</i>
                                                </span>
                                            </a>
                                        </li>
                                        

                                            

                                                    
                                                        <li>
                                                            <a target="_blank"
                                                                href="https://www.facebook.com/RanchoCooper">
                                                                <span class="fa-stack fa-lg">
                                                                    <i class="fa fa-circle fa-stack-2x"></i>
                                                                    <i
                                                                        class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                                                                </span>
                                                            </a>
                                                        </li>
                                                        

                                                            
                                                                <li>
                                                                    <a target="_blank"
                                                                        href="https://github.com/RanchoCooper">
                                                                        <span class="fa-stack fa-lg">
                                                                            <i class="fa fa-circle fa-stack-2x"></i>
                                                                            <i
                                                                                class="fa fa-github fa-stack-1x fa-inverse"></i>
                                                                        </span>
                                                                    </a>
                                                                </li>
                                                                

                                                                    
                                                                        <li>
                                                                            <a target="_blank"
                                                                                href="https://www.linkedin.com/in/ranchocooper">
                                                                                <span class="fa-stack fa-lg">
                                                                                    <i
                                                                                        class="fa fa-circle fa-stack-2x"></i>
                                                                                    <i
                                                                                        class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                                                                                </span>
                                                                            </a>
                                                                        </li>
                                                                        

                </ul>
                <p class="copyright text-muted">
                    Inland hosted by
                    <a target="_blank" rel="noopener" href="https://pages.coding.me" styles="font-weight: bold">Coding Pages</a>
                    <span style="display: inline-block; margin: 5px;">
                        <i class="fa fa-cog fa-spin fa-1x fa-fw"></i>
                    </span>
                    Foreign hosted by
                    <a target="_blank" rel="noopener" href="https://pages.github.com" styles="font-weight: bold">Github Pages</a>
                    <br>
                    Designed by <a target="_blank" rel="noopener" href="https://github.com/Huxpro">Hux</a>
                    <span style="display: inline-block; margin: 5px;">
                        <i class="fa fa-heart fa-sm"></i>
                    </span>
                    Powered by <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>
                    <br>
                    <iframe style="margin-right: 0px; margin-bottom:-5px; width: 105px;" frameborder="0" scrolling="0"
                        height="20px" allowtransparency="true"
                        src="https://ghbtns.com/github-btn.html?user=Huxpro&repo=huxpro.github.io&type=star&count=true">
                    </iframe>
                    <span style="display: inline-block; margin: 0 5px;">
                        <i class="fa fa-github fa-lg"></i>
                    </span>
                    <iframe style="margin-left: 0px; margin-bottom:-5px; width: 105px;" frameborder="0" scrolling="0"
                        height="20px" allowtransparency="true"
                        src="https://ghbtns.com/github-btn.html?user=hexojs&repo=hexo&type=star&count=true">
                    </iframe>
                    <br>
                    Copyright
                    <span style="display: inline-block; margin: 5px;">
                        <i class="fa fa-copyright"></i>
                    </span>
                    2017-2025
                        <br>
                        Rancho.
                            <br>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->

<script src="/js/jquery.min.js"></script>


    <!-- Bootstrap Core JavaScript -->
    
<script src="/js/bootstrap.min.js"></script>


        <!-- Custom Theme JavaScript -->
        
<script src="/js/hux-blog.min.js"></script>



            <!-- async load function -->
            <script>
                function async(u, c) {
                    var d = document, t = 'script',
                        o = d.createElement(t),
                        s = d.getElementsByTagName(t)[0];
                    o.src = u;
                    if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
                    s.parentNode.insertBefore(o, s);
                }
            </script>

            <!--
     Because of the native support for backtick-style fenced code blocks
     right within the Markdown is landed in Github Pages,
     From V1.6, There is no need for Highlight.js,
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/
-->
            <!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


            <!-- jquery.tagcloud.js -->
            <script>
                // only load tagcloud.js in tag.html
                if ($('#tag_cloud').length !== 0) {
                    async("https://blog.ranchocooper.com/js/jquery.tagcloud.js", function () {
                        $.fn.tagcloud.defaults = {
                            //size: {start: 1, end: 1, unit: 'em'},
                            color: { start: '#bbbbee', end: '#0085a1' },
                        };
                        $('#tag_cloud a').tagcloud();
                    })
                }
            </script>

            <!--fastClick.js -->
            <script>
                async("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function () {
                    var $nav = document.querySelector("nav");
                    if ($nav) FastClick.attach($nav);
                })
            </script>


            <!-- Google Analytics -->

            


                    <!-- Baidu Tongji -->
                    
                        <script>
                            // dynamic User by Hux
                            var _baId = '5baf1fd33b6f05a32bd0f48f4efb67a4';

                            // Originial
                            var _hmt = _hmt || [];
                            (function () {
                                var hm = document.createElement("script");
                                hm.src = "//hm.baidu.com/hm.js?" + _baId;
                                var s = document.getElementsByTagName("script")[0];
                                s.parentNode.insertBefore(hm, s);
                            })();
                        </script>
                        

                            <!-- Side Catalog -->
                            
                                <script type="text/javascript">
                                    function generateCatalog(selector) {
                                        function retract(index, item) {
                                            n = $(this).prop('tagName').toLowerCase();
                                            i = "#" + $(this).prop('id');
                                            t = $(this).text();
                                            c = $('<a href="' + i + '" rel="nofollow">' + t + '</a>');
                                            l = $('<li class="' + n + '_nav "></li>').append(c);
                                            $(selector).append(l);
                                            $(".side-catalog li").css("white-space", "nowrap");
                                            $("li").css("margin-top", "15px");

                                            $(".h1_nav").css("list-style-type", "disc");
                                            $(".h2_nav").css("list-style-type", "circle");
                                            $(".h3_nav").css("list-style-type", "square");

                                            $(".h1_nav").css("margin-left", -20);
                                            $(".h2_nav").css("margin-left", 0);
                                            $(".h3_nav").css("margin-left", 20);
                                            $(".h4_nav").css("margin-left", 40);
                                            $(".h5_nav").css("margin-left", 60);
                                            $(".h6_nav").css("margin-left", 80);
                                        }

                                        var P = $('div.post-container'), a, n, t, l, i, c;
                                        var a = [];
                                        a = P.find('h1,h2,h3,h4,h5,h6');

                                        a.each(retract)
                                        return true;
                                    }

                                    $(function () {
                                        var elm = $('.side-catalog');
                                        var startPos = $(elm).offset().top;
                                        var windowHeight = $(window).height();

                                        // 设置初始样式
                                        $(elm).css({
                                            'max-height': (windowHeight * 0.8) + 'px',
                                            'overflow-y': 'auto',
                                            'overflow-x': 'hidden'
                                        });

                                        $.event.add(window, "scroll", function () {
                                            var p = $(window).scrollTop();
                                            var footerOffset = $('footer').offset().top;
                                            var catalogHeight = $(elm).height();
                                            var bottomPosition = p + windowHeight;

                                            // 固定目录位置
                                            $(elm).css('position', ((p) > startPos) ? 'fixed' : 'relative');

                                            // 顶部位置
                                            $(elm).css('top', ((p) > startPos) ? '10%' : '40px');

                                            // 如果接近页脚，调整位置以避免覆盖页脚
                                            if (bottomPosition > footerOffset) {
                                                var newTop = Math.max(10, windowHeight - catalogHeight - (bottomPosition - footerOffset) - 20);
                                                $(elm).css('top', newTop + 'px');
                                            }
                                        });

                                        // 窗口大小改变时更新目录高度
                                        $(window).resize(function () {
                                            windowHeight = $(window).height();
                                            $(elm).css('max-height', (windowHeight * 0.8) + 'px');
                                        });
                                    });

                                    generateCatalog(".catalog-body");

                                    // toggle side catalog
                                    $(".catalog-toggle").click((function (e) {
                                        e.preventDefault();
                                        $('.side-catalog').toggleClass("fold")
                                    }))

                                    /*
                                     * Doc: https://github.com/davist11/jQuery-One-Page-Nav
                                     * Fork by Hux to support padding
                                     */
                                    async("/js/jquery.nav.js", function () {
                                        $('.catalog-body').onePageNav({
                                            currentClass: "active",
                                            changeHash: !1,
                                            easing: "swing",
                                            filter: "",
                                            scrollSpeed: 700,
                                            scrollOffset: 0,
                                            scrollThreshold: .2,
                                            begin: null,
                                            end: null,
                                            scrollChange: null,
                                            padding: 80
                                        });
                                    });
                                </script>
                                

                                    <!-- Side Catalog -->
                                    <script async
                                        src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

                                    <script>
                                        var _hmt = _hmt || [];
                                        (function () {
                                            var hm = document.createElement("script");
                                            hm.src = "https://hm.baidu.com/hm.js?5baf1fd33b6f05a32bd0f48f4efb67a4";
                                            var s = document.getElementsByTagName("script")[0];
                                            s.parentNode.insertBefore(hm, s);
                                        })();
                                    </script>


<!-- Image to hack wechat -->
<img src="https://blog.ranchocooper.com/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?5baf1fd33b6f05a32bd0f48f4efb67a4";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();

(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


</html>
